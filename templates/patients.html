{% extends "base.html" %}

{% block title %}Patients - Healthcare Management System{% endblock %}

{% block content %}
<div class="container">
    <!-- Page Header -->
    <div class="flex-between mb-3">
        <div class="page-header">
            <h1 class="page-title">Patient Records</h1>
            <p class="page-subtitle">Manage and view all patient information</p>
        </div>
        <a href="{{ url_for('create_patient') }}" class="btn btn-primary">
            + New Patient
        </a>
    </div>

    <!-- Filters -->
    <div class="filters">
        <form method="GET" action="{{ url_for('list_patients') }}">
            <div class="filter-grid">
                <div class="form-group" style="margin-bottom: 0;">
                    <label for="gender">Gender</label>
                    <select name="gender" id="gender">
                        <option value="">All</option>
                        <option value="Male" {% if request.args.get('gender') == 'Male' %}selected{% endif %}>Male</option>
                        <option value="Female" {% if request.args.get('gender') == 'Female' %}selected{% endif %}>Female</option>
                        <option value="Other" {% if request.args.get('gender') == 'Other' %}selected{% endif %}>Other</option>
                    </select>
                </div>

                <div class="form-group" style="margin-bottom: 0;">
                    <label for="stroke">Stroke History</label>
                    <select name="stroke" id="stroke">
                        <option value="">All</option>
                        <option value="0" {% if request.args.get('stroke') == '0' %}selected{% endif %}>No</option>
                        <option value="1" {% if request.args.get('stroke') == '1' %}selected{% endif %}>Yes</option>
                    </select>
                </div>

                <div class="form-group" style="margin-bottom: 0;">
                    <label for="smoking_status">Smoking Status</label>
                    <select name="smoking_status" id="smoking_status">
                        <option value="">All</option>
                        <option value="never smoked" {% if request.args.get('smoking_status') == 'never smoked' %}selected{% endif %}>Never Smoked</option>
                        <option value="formerly smoked" {% if request.args.get('smoking_status') == 'formerly smoked' %}selected{% endif %}>Formerly Smoked</option>
                        <option value="smokes" {% if request.args.get('smoking_status') == 'smokes' %}selected{% endif %}>Smokes</option>
                        <option value="Unknown" {% if request.args.get('smoking_status') == 'Unknown' %}selected{% endif %}>Unknown</option>
                    </select>
                </div>

                <div class="form-group" style="margin-bottom: 0;">
                    <label>&nbsp;</label>
                    <div class="btn-group">
                        <button type="submit" class="btn btn-primary">Filter</button>
                        <a href="{{ url_for('list_patients') }}" class="btn btn-secondary">Clear</a>
                    </div>
                </div>
            </div>
        </form>
    </div>

    <!-- Stats Summary -->
    <div class="stats-grid">
        <div class="stat-card">
            <div class="stat-label">Total Patients</div>
            <div class="stat-value">{{ total_patients }}</div>
        </div>
        <div class="stat-card" style="border-left-color: #10b981;">
            <div class="stat-label">Showing Results</div>
            <div class="stat-value" style="color: #10b981;">{{ patients|length }}</div>
        </div>
        <div class="stat-card" style="border-left-color: #f59e0b;">
            <div class="stat-label">Page</div>
            <div class="stat-value" style="color: #f59e0b; font-size: 1.5rem;">
                {{ page }} of {{ total_pages }}
            </div>
        </div>
    </div>

    <!-- Patients Table -->
    {% if patients %}
    <div class="table-container">
        <table>
            <thead>
                <tr>
                    <th>ID</th>
                    <th>Gender</th>
                    <th>Age</th>
                    <th>Hypertension</th>
                    <th>Heart Disease</th>
                    <th>BMI</th>
                    <th>Stroke</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody>
                {% for patient in patients %}
                <tr>
                    <td style="font-family: monospace; color: #64748b; font-size: 0.875rem;">{{ patient._id }}</td>
                    <td>
                        <span style="font-weight: 500;">{{ patient.gender }}</span>
                    </td>
                    <td>{{ patient.age }} years</td>
                    <td>
                        {% if patient.hypertension == 1 %}
                            <span class="badge" style="background: #fee2e2; color: #991b1b;">Yes</span>
                        {% else %}
                            <span class="badge" style="background: #d1fae5; color: #065f46;">No</span>
                        {% endif %}
                    </td>
                    <td>
                        {% if patient.heart_disease == 1 %}
                            <span class="badge" style="background: #fee2e2; color: #991b1b;">Yes</span>
                        {% else %}
                            <span class="badge" style="background: #d1fae5; color: #065f46;">No</span>
                        {% endif %}
                    </td>
                    <td>{{ "%.1f"|format(patient.bmi) }}</td>
                    <td>
                        {% if patient.stroke == 1 %}
                            <span class="badge" style="background: #fef3c7; color: #92400e;">Yes</span>
                        {% else %}
                            <span class="badge" style="background: #d1fae5; color: #065f46;">No</span>
                        {% endif %}
                    </td>
                    <td>
                        <div class="btn-group">
                            <a href="{{ url_for('patient_detail', patient_id=patient._id) }}" class="btn btn-sm btn-secondary">View</a>
                            <a href="{{ url_for('edit_patient', patient_id=patient._id) }}" class="btn btn-sm btn-primary">Edit</a>
                        </div>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>

    <!-- Pagination -->
    {% if total_pages > 1 %}
    <div class="pagination">
        <!-- First Page -->
        {% if page > 1 %}
        <a href="{{ url_for('list_patients', page=1, gender=request.args.get('gender', ''), stroke=request.args.get('stroke', ''), smoking_status=request.args.get('smoking_status', '')) }}">
            Â« First
        </a>
        {% endif %}

        <!-- Previous Page -->
        {% if page > 1 %}
        <a href="{{ url_for('list_patients', page=page-1, gender=request.args.get('gender', ''), stroke=request.args.get('stroke', ''), smoking_status=request.args.get('smoking_status', '')) }}">
            â€¹ Previous
        </a>
        {% endif %}

        <!-- Page Numbers -->
        {% for p in range([page - 2, 1]|max, [page + 2, total_pages]|min + 1) %}
            {% if p == page %}
                <span class="active">{{ p }}</span>
            {% else %}
                <a href="{{ url_for('list_patients', page=p, gender=request.args.get('gender', ''), stroke=request.args.get('stroke', ''), smoking_status=request.args.get('smoking_status', '')) }}">
                    {{ p }}
                </a>
            {% endif %}
        {% endfor %}

        <!-- Next Page -->
        {% if page < total_pages %}
        <a href="{{ url_for('list_patients', page=page+1, gender=request.args.get('gender', ''), stroke=request.args.get('stroke', ''), smoking_status=request.args.get('smoking_status', '')) }}">
            Next â€º
        </a>
        {% endif %}

        <!-- Last Page -->
        {% if page < total_pages %}
        <a href="{{ url_for('list_patients', page=total_pages, gender=request.args.get('gender', ''), stroke=request.args.get('stroke', ''), smoking_status=request.args.get('smoking_status', '')) }}">
            Last Â»
        </a>
        {% endif %}
    </div>
    {% endif %}

    {% else %}
    <!-- Empty State -->
    <div class="card">
        <div class="card-body">
            <div class="empty-state">
                <div class="empty-state-icon">ðŸ“‹</div>
                <h3 class="empty-state-title">No Patients Found</h3>
                <p class="empty-state-text">
                    {% if request.args.get('gender') or request.args.get('stroke') or request.args.get('smoking_status') %}
                        No patients match your current filters. Try adjusting your search criteria.
                    {% else %}
                        Get started by adding your first patient record.
                    {% endif %}
                </p>
                <a href="{{ url_for('create_patient') }}" class="btn btn-primary">Add Patient</a>
            </div>
        </div>
    </div>
    {% endif %}
</div>
{% endblock %}